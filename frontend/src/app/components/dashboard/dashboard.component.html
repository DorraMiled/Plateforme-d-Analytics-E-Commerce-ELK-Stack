<div class="dashboard-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-icon">
          <mat-icon>insights</mat-icon>
        </div>
        <div class="header-text">
          <h1>Dashboard E-commerce</h1>
          <p class="subtitle">Analyse des logs et suivi des transactions</p>
        </div>
      </div>
      <button mat-raised-button class="refresh-btn" (click)="refresh()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading && !stats" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des statistiques...</p>
  </div>

  <!-- Error State -->
  <mat-card *ngIf="error" class="error-card">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refresh()">Réessayer</button>
  </mat-card>

  <!-- KPI Cards -->
  <div *ngIf="stats" class="metrics-grid">
    <mat-card class="metric-card primary">
      <div class="metric-header">
        <div class="metric-icon">
          <mat-icon>shopping_cart</mat-icon>
        </div>
        <div class="metric-trend positive">
          <mat-icon>trending_up</mat-icon>
          <span>+12%</span>
        </div>
      </div>
      <mat-card-content>
        <div class="metric-value">{{ stats.total_logs | number }}</div>
        <div class="metric-label">Transactions Totales</div>
        <div class="metric-subtitle">Nombre total de logs traités</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card error">
      <div class="metric-header">
        <div class="metric-icon">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="metric-trend" [class.negative]="stats.error_logs > 0">
          <mat-icon>{{ stats.error_logs > 0 ? 'trending_down' : 'check_circle' }}</mat-icon>
          <span>{{ stats.error_logs }}</span>
        </div>
      </div>
      <mat-card-content>
        <div class="metric-value">{{ stats.error_logs | number }}</div>
        <div class="metric-label">Erreurs Détectées</div>
        <div class="metric-subtitle">Logs nécessitant attention</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card info">
      <div class="metric-header">
        <div class="metric-icon">
          <mat-icon>cloud_done</mat-icon>
        </div>
        <div class="metric-trend positive">
          <mat-icon>trending_up</mat-icon>
          <span>+8%</span>
        </div>
      </div>
      <mat-card-content>
        <div class="metric-value">{{ stats.files_uploaded | number }}</div>
        <div class="metric-label">Fichiers Importés</div>
        <div class="metric-subtitle">Documents traités avec succès</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Analytics Section -->
  <div *ngIf="stats" class="analytics-section">
    <div class="section-header">
      <mat-icon>bar_chart</mat-icon>
      <h2>Analyse des Logs</h2>
    </div>
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>analytics</mat-icon>
          Distribution par Niveau de Criticité
        </mat-card-title>
        <mat-card-subtitle>Répartition des logs selon leur niveau d'importance</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-wrapper">
          <canvas baseChart
            [type]="barChartType"
            [data]="barChartData"
            [options]="barChartOptions">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Recent Logs Table -->
  <div *ngIf="stats && stats.recent_logs" class="logs-section">
    <div class="section-header">
      <mat-icon>history</mat-icon>
      <h2>Logs Récents</h2>
    </div>
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list_alt</mat-icon>
          Dernières Transactions
        </mat-card-title>
        <mat-card-subtitle>Les 10 derniers événements enregistrés</mat-card-subtitle>
      </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="stats.recent_logs" class="full-width">
          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <th mat-header-cell *matHeaderCellDef>Date/Heure</th>
            <td mat-cell *matCellDef="let log">
              {{ log.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}
            </td>
          </ng-container>

          <!-- Level Column -->
          <ng-container matColumnDef="level">
            <th mat-header-cell *matHeaderCellDef>Niveau</th>
            <td mat-cell *matCellDef="let log">
              <span class="level-badge" [class]="log.level">
                {{ log.level }}
              </span>
            </td>
          </ng-container>

          <!-- Service Column -->
          <ng-container matColumnDef="service">
            <th mat-header-cell *matHeaderCellDef>Service</th>
            <td mat-cell *matCellDef="let log">{{ log.service }}</td>
          </ng-container>

          <!-- Message Column -->
          <ng-container matColumnDef="message">
            <th mat-header-cell *matHeaderCellDef>Message</th>
            <td mat-cell *matCellDef="let log" class="message-cell">
              {{ log.message }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
    </mat-card>
  </div>

  <!-- Quick Actions -->
  <div *ngIf="stats" class="actions-section">
    <div class="section-header">
      <mat-icon>bolt</mat-icon>
      <h2>Actions Rapides</h2>
    </div>
    <div class="actions-grid">
      <mat-card class="action-card" routerLink="/upload">
        <div class="action-icon upload">
          <mat-icon>cloud_upload</mat-icon>
        </div>
        <div class="action-content">
          <h3>Importer des Logs</h3>
          <p>Télécharger des fichiers CSV, JSON ou TXT</p>
        </div>
        <mat-icon class="arrow">arrow_forward</mat-icon>
      </mat-card>

      <mat-card class="action-card" routerLink="/search">
        <div class="action-icon search">
          <mat-icon>search</mat-icon>
        </div>
        <div class="action-content">
          <h3>Rechercher</h3>
          <p>Filtrer et analyser les logs en temps réel</p>
        </div>
        <mat-icon class="arrow">arrow_forward</mat-icon>
      </mat-card>

      <mat-card class="action-card" routerLink="/results">
        <div class="action-icon results">
          <mat-icon>assessment</mat-icon>
        </div>
        <div class="action-content">
          <h3>Voir Résultats</h3>
          <p>Consulter les données indexées et rapports</p>
        </div>
        <mat-icon class="arrow">arrow_forward</mat-icon>
      </mat-card>
    </div>
  </div>

  <!-- Kibana Dashboard Integration -->
  <div *ngIf="stats" class="kibana-section">
    <div class="section-header">
      <mat-icon>dashboard</mat-icon>
      <h2>Dashboard Kibana</h2>
      <a mat-raised-button color="primary" [href]="kibanaBaseUrl + '/app/dashboards'" target="_blank" class="open-kibana">
        <mat-icon>open_in_new</mat-icon>
        Ouvrir en plein écran
      </a>
    </div>
    <mat-card class="kibana-card">
      <mat-card-header>
        <mat-card-title>
          <div class="kibana-title">
            <mat-icon>analytics</mat-icon>
            <span>Visualisations E-commerce Avancées</span>
          </div>
        </mat-card-title>
        <mat-card-subtitle>
          <mat-icon>info</mat-icon>
          Graphiques interactifs des ventes et commandes en temps réel
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="kibana-iframe-container">
          <iframe 
            [src]="kibanaDashboardUrl" 
            class="kibana-iframe"
            title="Kibana E-commerce Dashboard"
            frameborder="0">
          </iframe>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
